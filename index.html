<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EZIO - Audit & Pilotage IA</title>

    <link rel="stylesheet" href="style_shared.css">
    <link rel="stylesheet" href="style_creator.css">
    <link rel="stylesheet" href="style_audit.css">
    <link rel="stylesheet" href="style_dashboard.css">
    <link rel="stylesheet" href="style_models.css">
    <link rel="stylesheet" href="style_reports.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
</head>

<body>
    <header>
        <div class="header-left">
            <button id="toggleSidebarBtn" class="btn-icon" title="Masquer/Afficher le menu">‚ò∞</button>
            <h1>EZIO<span class="badge-ia">IA Powered</span></h1>
            <div class="separator-vertical"></div>
            <button id="loadBtn" class="btn-secondary">Charger</button>
            <button id="saveBtn" class="btn-primary">Sauver</button>
            <button id="exportBtn" class="btn-primary" onclick="openExportModal()">Exporter</button>
            <div class="separator-vertical"></div>
            <button id="resetBtn" class="btn-danger" title="Tout effacer">R√©init.</button>

        </div>
        <div class="header-center">
            <input type="text" id="searchInput" class="search-input" placeholder="üîç Rechercher...">
        </div>
        <div class="header-right">
            <button id="btnShowApp" class="btn-primary">Audit</button>
            <button id="btnShowDashboard" class="btn-primary">Tableau de Bord</button>
            <button id="btnToggleNotes" class="btn-secondary" title="Prises de notes">Notes</button>
            <div class="separator-vertical"></div>
            <button id="btnShowCreator" class="btn-secondary">Formulaires</button>
            <button id="btnShowModels" class="btn-secondary">Agents</button>
            <button id="btnShowReports" class="btn-secondary">Rapports</button>

            <div class="separator-vertical"></div>
            <button id="themeBtn" class="btn-secondary" title="Changer de th√®me">üåô</button>
            <button id="btnDocs" class="btn-secondary" title="Ouvrir la documentation">?</button>
        </div>
    </header>

    <main id="app-container">
        <div id="audit-view" class="view-section">
            <aside id="sidebar" class="sidebar hidden">
                <h3 class="sidebar-title">Navigation</h3>
                <ul id="chapterList" class="chapter-list"></ul>
            </aside>
            <div class="content-area">
                <div id="tableContainer" class="table-responsive">
                    <div class="empty-state">
                        <p>Aucune donn√©e charg√©e.</p>
                        <p>Importez un fichier JSON existant ou cr√©ez-en un nouveau.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboard-view" class="view-section hidden">
            <div class="dashboard-container">
                <div class="dashboard-header">
                    <h2>Tableau de Bord</h2>
                    <div class="dashboard-actions">
                        <select id="kpiColSelect" class="config-input" style="width: 250px;">
                            <option value="">-- Chargement des colonnes... --</option>
                        </select>
                        <select id="kpiTypeSelect" class="config-input" style="width: 150px;">
                            <option value="pie">Camembert</option>
                            <option value="bar">Barres</option>
                            <option value="doughnut">Anneau</option>
                        </select>
                        <button id="btnAddWidget" class="btn-primary">+ Ajouter le widget</button>
                    </div>
                </div>
                <div id="dashboardGrid" class="dashboard-grid"></div>
            </div>
        </div>

        <div id="creator-view" class="view-section hidden">
            <div class="creator-container">
                <div class="creator-header">
                    <h2>G√©n√©rateur de Formulaire</h2>
                    <p>Transformez votre fichier JSON source en application d'audit intelligente.</p>
                    <div class="file-upload-box">
                        <label for="csvInput" class="btn-primary">üìÇ Importer un fichier de donn√©es</label>
                        <input type="file" id="csvInput" accept=".json" hidden>
                        <span id="csvFileName" class="file-name">Aucun fichier choisi</span>
                        <div class="separator-vertical"></div>
                        <button id="btnOpenAddCol" class="btn-secondary">+ Ajouter une colonne</button>
                    </div>
                </div>
                <div id="creatorConfig" class="creator-config hidden">
                    <div class="table-responsive">
                        <table id="configTable"></table>
                    </div>
                    <div class="creator-actions">
                        <button id="generateJsonBtn" class="btn-primary large">üíæ G√©n√©rer et Charger le JSON</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW MODELS -->
        <div id="models-view" class="view-section hidden">
            <div class="manager-container">
                <!-- SIDEBAR -->
                <aside class="model-sidebar">
                    <div class="sidebar-actions">
                        <button id="btnNewModel" class="btn-primary" style="width: 100%;">+ Nouvel agent</button>
                    </div>
                    <div id="modelList" class="model-list">
                        <!-- Items inject√©s par JS -->
                    </div>
                    <div class="sidebar-actions">
                        <small style="color: var(--text-muted);">Stock√© dans models.json</small>
                    </div>
                </aside>

                <!-- MAIN EDITOR -->
                <main id="editorArea" class="main-editor">
                    <div id="statusMsg" class="status-bar"></div>

                    <div id="emptyState" class="empty-selection">
                        <p>S√©lectionnez un mod√®le pour l'√©diter ou cr√©ez-en un nouveau.</p>
                    </div>

                    <div id="editForm" class="hidden">
                        <div class="editor-card">
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label>Nom</label>
                                        <input type="text" id="inpName" class="form-control"
                                            placeholder="Ex: Assistant Audit">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label>Description</label>
                                        <input type="text" id="inpDesc" class="form-control"
                                            placeholder="Courte description...">
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Prompt Syst√®me (Instructions de base)</label>
                                <textarea id="inpPrompt" class="form-control" rows="5"
                                    placeholder="Tu es un expert..."></textarea>
                            </div>
                        </div>

                        <div class="editor-card">
                            <h3 style="margin-bottom: 15px; font-size: 1rem; color: var(--primary);">Configuration
                                Technique</h3>

                            <!-- Ligne 1 : Provider | Endpoint | API Key -->
                            <div class="form-row" style="align-items: flex-end;">
                                <div class="form-col" style="flex: 0 0 150px;">
                                    <div class="form-group">
                                        <label>Fournisseur</label>
                                        <select id="inpProvider" class="form-control">
                                            <option value="lmstudio">LM Studio (Local)</option>
                                            <option value="openai">OpenAI</option>
                                            <option value="mock">Mock</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label>Endpoint API</label>
                                        <input type="text" id="inpEndpoint" class="form-control"
                                            placeholder="http://localhost:1234/v1/chat/completions">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label>Cl√© API</label>
                                        <input type="password" id="inpApiKey" class="form-control" placeholder="sk-...">
                                    </div>
                                </div>
                                <div class="form-col" style="flex: 0 0 auto;">
                                    <div class="form-group">
                                        <button id="btnTestConnection" class="btn-secondary"
                                            title="Tester la connexion et lister les mod√®les">
                                            Test ‚ö°
                                        </button>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label>ID du Mod√®le</label>
                                        <!-- Utilisation d'un datalist pour faire office de ComboBox (Saisie libre + Choix) -->
                                        <input type="text" id="inpModelId" class="form-control" list="modelListOptions"
                                            placeholder="ex: gpt-4, mistral-small..." autocomplete="off">
                                        <datalist id="modelListOptions"></datalist>
                                    </div>
                                </div>
                            </div>


                            <!-- Ligne 3 : Temp√©rature | Contexte -->
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label>Temp√©rature (0.0 - 1.0)</label>
                                        <input type="number" id="inpTemp" class="form-control" step="0.1" min="0"
                                            max="2" value="0.7">
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label>Contexte (Tokens)</label>
                                        <input type="number" id="inpContext" class="form-control" value="4096">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="editor-card"
                            style="text-align: right; background: transparent; border: none; box-shadow: none; padding: 0;">
                            <button id="btnDeleteModel" class="btn-danger">Supprimer</button>
                            <button id="btnSaveModel" class="btn-primary" style="padding: 10px 20px;">üíæ Enregistrer les
                                modifications</button>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- VIEW REPORTS -->
        <div id="reports-view" class="view-section hidden">
            <div class="reports-container">
                <aside class="reports-sidebar">
                    <div class="sidebar-header">
                        <h3>Biblioth√®que</h3>
                        <!-- Buttons moved to list headers -->
                        <button id="btnNewReport" class="btn-primary small hidden">+ Rapport</button>
                        <button id="btnNewModule" class="btn-secondary small hidden">+ Module</button>
                    </div>
                    <div id="libraryList" class="library-list">
                        <!-- Loaded via JS -->
                    </div>
                </aside>
                <main id="reportEditor" class="report-editor">
                    <div id="editorEmptyState" class="empty-state">
                        <p>S√©lectionnez un rapport ou un module pour commencer.</p>
                    </div>
                    <div id="reportBuilder" class="builder-area hidden">
                        <header class="builder-header">
                            <input type="text" id="reportTitleInput" class="title-input" placeholder="Nom du rapport">
                            <div class="builder-actions">
                                <button id="btnSaveReport" class="btn-primary">üíæ Sauvegarder</button>
                                <button id="btnRunReport" class="btn-primary"
                                    style="margin-left: 10px; background-color: var(--ia-color); border-color: var(--ia-border);">‚ñ∂Ô∏è
                                    G√©n√©rer</button>
                            </div>
                        </header>
                        <div id="modulesGrid" class="modules-grid">
                            <!-- Modules will be dropped here -->
                        </div>
                    </div>
                    <div id="moduleEditor" class="module-config hidden">
                        <header class="builder-header">
                            <h2>√âditer le Module</h2>
                            <div class="builder-actions">
                                <button id="btnCancelModule" class="btn-secondary">Annuler</button>
                                <button id="btnSaveModule" class="btn-primary">üíæ Enregistrer</button>
                            </div>
                        </header>
                        <div class="editor-content" style="padding: 2rem; overflow-y: auto;">
                            <input type="hidden" id="modId">

                            <div class="form-group">
                                <label>Nom du module</label>
                                <input type="text" id="modName" class="form-control"
                                    placeholder="Ex: Analyse Chapitre 1">
                            </div>

                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label>Type de contenu</label>
                                        <select id="modType" class="form-control">
                                            <option value="analysis">Analyse IA</option>
                                            <option value="raw">Donn√©es Brutes</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label>Port√©e (Scope)</label>
                                        <select id="modScopeType" class="form-control">
                                            <option value="global">Global (Tout l'audit)</option>
                                            <option value="chapter">Chapitre sp√©cifique</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div id="scopeValueGroup" class="form-group hidden">
                                <label>S√©lectionner le Chapitre</label>
                                <select id="modScopeValue" class="form-control">
                                    <!-- Populated via JS -->
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Colonnes √† inclure (Donn√©es)</label>
                                <div id="modColumnsContainer" class="checkbox-group"
                                    style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; border-radius: 4px; background: var(--bg-color);">
                                    <!-- Populated via JS -->
                                    <div class="text-muted small">Aucune donn√©e charg√©e.</div>
                                </div>
                                <small class="text-muted">S√©lectionnez les colonnes pertinentes pour l'analyse
                                    IA.</small>
                            </div>

                            <hr style="margin: 2rem 0; border: 0; border-top: 1px solid var(--border-color);">

                            <h3>Configuration IA</h3>
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label>Mod√®le IA</label>
                                        <select id="modAiModel" class="form-control">
                                            <!-- Populated via JS from models.json -->
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Prompt Syst√®me / Instructions</label>
                                <textarea id="modAiPrompt" class="form-control" rows="6"
                                    placeholder="Instructions pour l'IA..."></textarea>
                                <small class="text-muted">Utilisez ce champ pour d√©finir comment l'IA doit traiter les
                                    donn√©es.</small>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </main>

    <div id="resetModal" class="modal hidden">
        <div class="modal-content">
            <h3>Confirmer la r√©initialisation ?</h3>
            <p>Toutes les donn√©es en cours seront effac√©es. Cette action est irr√©versible.</p>
            <div class="modal-actions">
                <button id="confirmResetBtn" class="btn-danger">Confirmer</button>
                <button id="cancelResetBtn" class="btn-secondary">Annuler</button>
            </div>
        </div>
    </div>

    <div id="modalLoad" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3>Charger un Audit</h3>
            <div class="load-options">
                <div class="load-section">
                    <h4>Mod√®les (Templates)</h4><br>
                    <ul id="templateList" class="template-list">
                        <li>Chargement des mod√®les...</li>
                    </ul>
                </div>
                <div class="load-section divider">
                    <h4>Fichier Local</h4><br>
                    <label for="jsonInput" class="btn btn-secondary">Parcourir mon poste</label>
                    <input type="file" id="jsonInput" accept=".json" hidden>
                </div>
            </div>
        </div>
    </div>

    <div id="exportModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeExportModal">&times;</span>
            <h3>Exporter les donn√©es</h3>
            <p>Choisissez un format d'export :</p>
            <div id="exportFormatList" class="export-list">
                <!-- Formats inject√©s par JS -->
            </div>
        </div>
    </div>

    <!-- MODAL AJOUT COLONNE -->
    <div id="addColumnModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeAddColModal">&times;</span>
            <h3>Ajouter une colonne</h3>
            <p>Entrez le nom de la nouvelle colonne :</p>
            <div class="form-group">
                <input type="text" id="inpNewColName" class="form-control" placeholder="Ex: Commentaires..."
                    style="width: 100%; box-sizing: border-box;">
            </div>
            <div class="modal-actions" style="margin-top: 1rem; justify-content: flex-end; display: flex; gap: 10px;">
                <button id="btnCancelAddCol" class="btn-secondary">Annuler</button>
                <button id="btnConfirmAddCol" class="btn-primary">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- NOTES CONTAINER -->
    <div id="notesContainer" class="notes-container hidden">
        <div class="notes-header">
            <h3>Notes</h3>
            <button id="btnCloseNotes" class="btn-icon">‚úñ</button>
        </div>
        <textarea id="notesTextarea" placeholder="Vos notes ici..."></textarea>
    </div>

    <script src="api_ia.js"></script>
    <script src="app_shared.js"></script>
    <script src="app_creator.js"></script>
    <script src="app_dashboard.js"></script>
    <script src="app_audit.js"></script>
    <script src="app_export.js"></script>
    <script src="app_models.js"></script>
    <script src="app_reports.js"></script>
</body>

</html>